
<xml xmlns="https://developers.google.com/blockly/xml" is_dbot="true" collection="false">
  <variables>
    <variable id="v_base_stake">base_stake</variable>
    <variable id="v_recovery_mult">recovery_mult</variable>
    <variable id="v_max_recoveries">max_recoveries</variable>
    <variable id="v_session_loss_limit">session_loss_limit</variable>
    <variable id="v_current_recovery">current_recovery</variable>
    <variable id="v_last_result">last_result</variable>
    <variable id="v_balance0">starting_balance</variable>
  </variables>
  
  <!-- Trade Definition -->
  <block type="trade_definition" id="trade_def_1" deletable="false" x="0" y="0">
    <statement name="TRADE_OPTIONS">
      <block type="trade_definition_market" id="market_1" deletable="false" movable="false">
        <field name="MARKET_LIST">synthetic_index</field>
        <field name="SUBMARKET_LIST">random_index</field>
        <field name="SYMBOL_LIST">1HZ100V</field>
        <next>
          <block type="trade_definition_tradetype" id="tradetype_1" deletable="false" movable="false">
            <field name="TRADETYPECAT_LIST">digits</field>
            <field name="TRADETYPE_LIST">matchesdiffers</field>
            <next>
              <block type="trade_definition_contracttype" id="contracttype_1" deletable="false" movable="false">
                <field name="TYPE_LIST">both</field>
                <next>
                  <block type="trade_definition_candleinterval" id="candle_1" deletable="false" movable="false">
                    <field name="CANDLEINTERVAL_LIST">60</field>
                    <next>
                      <block type="trade_definition_restartbuysell" id="restart_1" deletable="false" movable="false">
                        <field name="TIME_MACHINE_ENABLED">FALSE</field>
                        <next>
                          <block type="trade_definition_restartonerror" id="error_1" deletable="false" movable="false">
                            <field name="RESTARTONERROR">TRUE</field>
                          </block>
                        </next>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
            </next>
          </block>
        </next>
      </block>
    </statement>
    
    <!-- Initialization -->
    <statement name="INITIALIZATION">
      <block type="variables_set" id="init_base_stake">
        <field name="VAR" id="v_base_stake">base_stake</field>
        <value name="VALUE">
          <block type="math_number" id="base_stake_val">
            <field name="NUM">1</field>
          </block>
        </value>
        <next>
          <block type="variables_set" id="init_recovery_mult">
            <field name="VAR" id="v_recovery_mult">recovery_mult</field>
            <value name="VALUE">
              <block type="math_number" id="recovery_mult_val">
                <field name="NUM">2</field>
              </block>
            </value>
            <next>
              <block type="variables_set" id="init_max_recoveries">
                <field name="VAR" id="v_max_recoveries">max_recoveries</field>
                <value name="VALUE">
                  <block type="math_number" id="max_recoveries_val">
                    <field name="NUM">4</field>
                  </block>
                </value>
                <next>
                  <block type="variables_set" id="init_loss_limit">
                    <field name="VAR" id="v_session_loss_limit">session_loss_limit</field>
                    <value name="VALUE">
                      <block type="math_number" id="loss_limit_val">
                        <field name="NUM">-50</field>
                      </block>
                    </value>
                    <next>
                      <block type="variables_set" id="init_recovery">
                        <field name="VAR" id="v_current_recovery">current_recovery</field>
                        <value name="VALUE">
                          <block type="math_number" id="recovery_val">
                            <field name="NUM">0</field>
                          </block>
                        </value>
                        <next>
                          <block type="variables_set" id="init_balance">
                            <field name="VAR" id="v_balance0">starting_balance</field>
                            <value name="VALUE">
                              <block type="balance" id="get_balance"></block>
                            </value>
                          </block>
                        </next>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
            </next>
          </block>
        </next>
      </block>
    </statement>
    
    <!-- Trade Options -->
    <statement name="SUBMARKET">
      <block type="trade_definition_tradeoptions" id="trade_options">
        <mutation xmlns="http://www.w3.org/1999/xhtml" has_first_barrier="false" has_second_barrier="false" has_prediction="true"></mutation>
        <field name="DURATIONTYPE_LIST">t</field>
        <value name="DURATION">
          <shadow type="math_number" id="duration_val">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="AMOUNT">
          <shadow type="math_number" id="amount_shadow">
            <field name="NUM">1</field>
          </shadow>
          <block type="procedures_callreturn" id="get_stake_amount">
            <mutation xmlns="http://www.w3.org/1999/xhtml" name="Calculate Stake"></mutation>
            <data>calc_stake_func</data>
          </block>
        </value>
        <value name="PREDICTION">
          <shadow type="math_number" id="prediction_shadow">
            <field name="NUM">5</field>
          </shadow>
          <block type="procedures_callreturn" id="get_prediction">
            <mutation xmlns="http://www.w3.org/1999/xhtml" name="Get Best Prediction"></mutation>
            <data>best_prediction_func</data>
          </block>
        </value>
      </block>
    </statement>
  </block>
  
  <!-- Before Purchase -->
  <block type="before_purchase" id="before_purchase_1" deletable="false" x="0" y="600">
    <statement name="BEFOREPURCHASE_STACK">
      <block type="purchase" id="purchase_1">
        <field name="PURCHASE_LIST">DIGITDIFF</field>
      </block>
    </statement>
  </block>
  
  <!-- After Purchase -->
  <block type="after_purchase" id="after_purchase_1" x="400" y="600">
    <statement name="AFTERPURCHASE_STACK">
      <block type="controls_if" id="check_result">
        <value name="IF0">
          <block type="contract_check_result" id="is_win">
            <field name="CHECK_RESULT">win</field>
          </block>
        </value>
        <statement name="DO0">
          <!-- Reset recovery on win -->
          <block type="variables_set" id="reset_recovery">
            <field name="VAR" id="v_current_recovery">current_recovery</field>
            <value name="VALUE">
              <block type="math_number" id="zero_recovery">
                <field name="NUM">0</field>
              </block>
            </value>
            <next>
              <block type="notify" id="win_notification">
                <field name="NOTIFICATION_TYPE">success</field>
                <field name="NOTIFICATION_SOUND">silent</field>
                <value name="MESSAGE">
                  <shadow type="text" id="win_msg">
                    <field name="TEXT">Trade Won! Recovery reset.</field>
                  </shadow>
                </value>
              </block>
            </next>
          </block>
        </statement>
        <statement name="ELSE">
          <!-- Increase recovery on loss -->
          <block type="math_change" id="inc_recovery">
            <field name="VAR" id="v_current_recovery">current_recovery</field>
            <value name="DELTA">
              <shadow type="math_number" id="one_delta">
                <field name="NUM">1</field>
              </shadow>
            </value>
            <next>
              <block type="notify" id="loss_notification">
                <field name="NOTIFICATION_TYPE">warn</field>
                <field name="NOTIFICATION_SOUND">silent</field>
                <value name="MESSAGE">
                  <shadow type="text" id="loss_msg">
                    <field name="TEXT">Trade Lost! Entering recovery mode.</field>
                  </shadow>
                </value>
              </block>
            </next>
          </block>
        </statement>
        <next>
          <block type="controls_if" id="check_limits">
            <mutation xmlns="http://www.w3.org/1999/xhtml" else="1"></mutation>
            <value name="IF0">
              <block type="logic_operation" id="limit_check">
                <field name="OP">OR</field>
                <value name="A">
                  <block type="logic_compare" id="recovery_limit">
                    <field name="OP">GT</field>
                    <value name="A">
                      <block type="variables_get" id="get_recovery">
                        <field name="VAR" id="v_current_recovery">current_recovery</field>
                      </block>
                    </value>
                    <value name="B">
                      <block type="variables_get" id="get_max_recovery">
                        <field name="VAR" id="v_max_recoveries">max_recoveries</field>
                      </block>
                    </value>
                  </block>
                </value>
                <value name="B">
                  <block type="logic_compare" id="loss_limit">
                    <field name="OP">LT</field>
                    <value name="A">
                      <block type="math_arithmetic" id="calc_pnl">
                        <field name="OP">MINUS</field>
                        <value name="A">
                          <block type="balance" id="current_balance">
                          </block>
                        </value>
                        <value name="B">
                          <block type="variables_get" id="get_start_balance">
                            <field name="VAR" id="v_balance0">starting_balance</field>
                          </block>
                        </value>
                      </block>
                    </value>
                    <value name="B">
                      <block type="variables_get" id="get_loss_limit">
                        <field name="VAR" id="v_session_loss_limit">session_loss_limit</field>
                      </block>
                    </value>
                  </block>
                </value>
              </block>
            </value>
            <statement name="DO0">
              <block type="notify" id="stop_notification">
                <field name="NOTIFICATION_TYPE">error</field>
                <field name="NOTIFICATION_SOUND">silent</field>
                <value name="MESSAGE">
                  <shadow type="text" id="stop_msg">
                    <field name="TEXT">Limits reached! Bot stopped.</field>
                  </shadow>
                </value>
              </block>
            </statement>
            <statement name="ELSE">
              <block type="trade_again" id="continue_trading"></block>
            </statement>
          </block>
        </next>
      </block>
    </statement>
  </block>
  
  <!-- Calculate Stake Function -->
  <block type="procedures_defreturn" id="calc_stake_func" collapsed="true" x="800" y="0">
    <field name="NAME">Calculate Stake</field>
    <statement name="STACK">
      <block type="variables_set" id="calc_stake_amount">
        <field name="VAR" id="v_last_result">last_result</field>
        <value name="VALUE">
          <block type="math_arithmetic" id="stake_calc">
            <field name="OP">MULTIPLY</field>
            <value name="A">
              <block type="variables_get" id="base_stake_get">
                <field name="VAR" id="v_base_stake">base_stake</field>
              </block>
            </value>
            <value name="B">
              <block type="math_arithmetic" id="power_calc">
                <field name="OP">POWER</field>
                <value name="A">
                  <block type="variables_get" id="recovery_mult_get">
                    <field name="VAR" id="v_recovery_mult">recovery_mult</field>
                  </block>
                </value>
                <value name="B">
                  <block type="variables_get" id="current_recovery_get">
                    <field name="VAR" id="v_current_recovery">current_recovery</field>
                  </block>
                </value>
              </block>
            </value>
          </block>
        </value>
      </block>
    </statement>
    <value name="RETURN">
      <block type="variables_get" id="return_stake">
        <field name="VAR" id="v_last_result">last_result</field>
      </block>
    </value>
  </block>
  
  <!-- Get Best Prediction Function -->
  <block type="procedures_defreturn" id="best_prediction_func" collapsed="true" x="800" y="200">
    <field name="NAME">Get Best Prediction</field>
    <statement name="STACK">
      <!-- Simple prediction logic - can be enhanced -->
      <block type="variables_set" id="set_prediction">
        <field name="VAR" id="v_last_result">last_result</field>
        <value name="VALUE">
          <block type="math_random_int" id="random_prediction">
            <value name="FROM">
              <shadow type="math_number" id="from_digit">
                <field name="NUM">0</field>
              </shadow>
            </value>
            <value name="TO">
              <shadow type="math_number" id="to_digit">
                <field name="NUM">9</field>
              </shadow>
            </value>
          </block>
        </value>
      </block>
    </statement>
    <value name="RETURN">
      <block type="variables_get" id="return_prediction">
        <field name="VAR" id="v_last_result">last_result</field>
      </block>
    </value>
  </block>
</xml>
