
<xml xmlns="https://developers.google.com/blockly/xml">
  <variables>
    <variable id="v_base_stake">base_stake</variable>
    <variable id="v_recovery_mult">recovery_mult</variable>
    <variable id="v_max_recoveries">max_recoveries</variable>
    <variable id="v_session_loss_limit">session_loss_limit</variable>
    <variable id="v_current_recovery">current_recovery</variable>
    <variable id="v_last_result">last_result</variable>
    <variable id="v_balance0">starting_balance</variable>
    <variable id="v_chosen_digit">chosen_digit</variable>
    <variable id="v_chosen_contract">chosen_contract</variable>
    <variable id="v_best_prob">best_prob</variable>
    <variable id="v_best_side">best_side</variable>
    <variable id="v_best_digit">best_digit</variable>
  </variables>

  <block type="trade_definition" id="trade_definition" x="0" y="0">
    <field name="MARKET">synthetic_indices</field>
    <field name="SYMBOL">R_100</field>
    <field name="TRADETYPE">digitover</field>
    <field name="CONTRACT_TYPE">DIGITOVER</field>
    <value name="AMOUNT">
      <block type="math_number" id="amount_block">
        <field name="NUM">1</field>
      </block>
    </value>
    <value name="DURATION">
      <block type="math_number" id="duration_block">
        <field name="NUM">1</field>
      </block>
    </value>
    <value name="DURATIONUNIT">
      <block type="text" id="duration_unit_block">
        <field name="TEXT">t</field>
      </block>
    </value>
    <value name="DIGIT">
      <block type="math_number" id="digit_block">
        <field name="NUM">1</field>
      </block>
    </value>
    
    <statement name="INITIALIZATION">
      <block type="variables_set" id="set_base_stake">
        <field name="VAR" id="v_base_stake">base_stake</field>
        <value name="VALUE">
          <block type="math_number" id="base_stake_num">
            <field name="NUM">1</field>
          </block>
        </value>
        <next>
          <block type="variables_set" id="set_recovery_mult">
            <field name="VAR" id="v_recovery_mult">recovery_mult</field>
            <value name="VALUE">
              <block type="math_number" id="recovery_mult_num">
                <field name="NUM">2</field>
              </block>
            </value>
            <next>
              <block type="variables_set" id="set_max_recoveries">
                <field name="VAR" id="v_max_recoveries">max_recoveries</field>
                <value name="VALUE">
                  <block type="math_number" id="max_recoveries_num">
                    <field name="NUM">4</field>
                  </block>
                </value>
                <next>
                  <block type="variables_set" id="set_session_loss">
                    <field name="VAR" id="v_session_loss_limit">session_loss_limit</field>
                    <value name="VALUE">
                      <block type="math_number" id="session_loss_num">
                        <field name="NUM">-50</field>
                      </block>
                    </value>
                    <next>
                      <block type="variables_set" id="set_current_recovery">
                        <field name="VAR" id="v_current_recovery">current_recovery</field>
                        <value name="VALUE">
                          <block type="math_number" id="current_recovery_num">
                            <field name="NUM">0</field>
                          </block>
                        </value>
                        <next>
                          <block type="variables_set" id="set_starting_balance">
                            <field name="VAR" id="v_balance0">starting_balance</field>
                            <value name="VALUE">
                              <block type="balance" id="balance_init"/>
                            </value>
                          </block>
                        </next>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
            </next>
          </block>
        </next>
      </block>
    </statement>

    <statement name="SUBMARKET">
      <block type="controls_whileUntil" id="main_trading_loop">
        <field name="MODE">WHILE</field>
        <value name="BOOL">
          <block type="logic_compare" id="session_limit_check">
            <field name="OP">GT</field>
            <value name="A">
              <block type="math_arithmetic" id="current_pnl">
                <field name="OP">MINUS</field>
                <value name="A">
                  <block type="balance" id="current_balance"/>
                </value>
                <value name="B">
                  <block type="variables_get" id="get_starting_balance">
                    <field name="VAR" id="v_balance0">starting_balance</field>
                  </block>
                </value>
              </block>
            </value>
            <value name="B">
              <block type="variables_get" id="get_session_limit">
                <field name="VAR" id="v_session_loss_limit">session_loss_limit</field>
              </block>
            </value>
          </block>
        </value>
        
        <statement name="DO">
          <block type="variables_set" id="calculate_stake">
            <field name="VAR" id="v_base_stake">base_stake</field>
            <value name="VALUE">
              <block type="math_arithmetic" id="stake_calculation">
                <field name="OP">MULTIPLY</field>
                <value name="A">
                  <block type="math_number" id="base_amount">
                    <field name="NUM">1</field>
                  </block>
                </value>
                <value name="B">
                  <block type="math_arithmetic" id="power_calculation">
                    <field name="OP">POWER</field>
                    <value name="A">
                      <block type="variables_get" id="get_recovery_mult">
                        <field name="VAR" id="v_recovery_mult">recovery_mult</field>
                      </block>
                    </value>
                    <value name="B">
                      <block type="variables_get" id="get_current_recovery">
                        <field name="VAR" id="v_current_recovery">current_recovery</field>
                      </block>
                    </value>
                  </block>
                </value>
              </block>
            </value>
            
            <next>
              <block type="purchase" id="make_purchase">
                <field name="PURCHASE_LIST">purchase</field>
                <value name="AMOUNT">
                  <block type="variables_get" id="get_calculated_stake">
                    <field name="VAR" id="v_base_stake">base_stake</field>
                  </block>
                </value>
              </block>
            </next>
          </block>
        </statement>
      </block>
    </statement>

    <statement name="AFTERPURCHASE">
      <block type="controls_if" id="check_trade_result">
        <value name="IF0">
          <block type="contract_check_result" id="check_if_won">
            <field name="CHECK_RESULT">win</field>
          </block>
        </value>
        
        <statement name="DO0">
          <block type="variables_set" id="reset_recovery_on_win">
            <field name="VAR" id="v_current_recovery">current_recovery</field>
            <value name="VALUE">
              <block type="math_number" id="reset_to_zero">
                <field name="NUM">0</field>
              </block>
            </value>
          </block>
        </statement>
        
        <statement name="ELSE">
          <block type="variables_set" id="increment_recovery">
            <field name="VAR" id="v_current_recovery">current_recovery</field>
            <value name="VALUE">
              <block type="math_arithmetic" id="add_one_recovery">
                <field name="OP">ADD</field>
                <value name="A">
                  <block type="variables_get" id="get_current_recovery_loss">
                    <field name="VAR" id="v_current_recovery">current_recovery</field>
                  </block>
                </value>
                <value name="B">
                  <block type="math_number" id="one_increment">
                    <field name="NUM">1</field>
                  </block>
                </value>
              </block>
            </value>
            
            <next>
              <block type="controls_if" id="check_max_recovery">
                <value name="IF0">
                  <block type="logic_compare" id="compare_max_recovery">
                    <field name="OP">GT</field>
                    <value name="A">
                      <block type="variables_get" id="get_current_recovery_check">
                        <field name="VAR" id="v_current_recovery">current_recovery</field>
                      </block>
                    </value>
                    <value name="B">
                      <block type="variables_get" id="get_max_recoveries_check">
                        <field name="VAR" id="v_max_recoveries">max_recoveries</field>
                      </block>
                    </value>
                  </block>
                </value>
                
                <statement name="DO0">
                  <block type="trade_again" id="stop_trading">
                    <field name="TRADE_AGAIN">false</field>
                  </block>
                </statement>
              </block>
            </next>
          </block>
        </statement>
      </block>
    </statement>
  </block>
</xml>
