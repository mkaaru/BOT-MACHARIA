let derivWs,reconnectTimeout;let tickHistory=[],currentSymbol="R_10",tickCount=120,decimalPlaces=2,overUnderBarrier=5,isInitialized=!1,reconnectAttempts=0,MAX_RECONNECT_ATTEMPTS=5;function startWebSocket(){if(console.log("\uD83D\uDD0C Connecting to WebSocket API"),reconnectTimeout&&clearTimeout(reconnectTimeout),derivWs){try{derivWs.onclose=null,derivWs.close(),console.log("Closed existing connection")}catch(e){console.error("Error closing existing connection:",e)}derivWs=null}try{(derivWs=new WebSocket("wss://ws.binaryws.com/websockets/v3?app_id=68848")).onopen=function(){console.log("‚úÖ WebSocket connection established"),reconnectAttempts=0,notifyConnectionStatus("connected"),setTimeout(()=>{try{derivWs&&derivWs.readyState===WebSocket.OPEN&&(console.log("Sending authorization request"),derivWs.send(JSON.stringify({app_id:68848})),requestTickHistory())}catch(e){console.error("Error during init requests:",e)}},500)},derivWs.onmessage=function(e){try{let t=JSON.parse(e.data);if(t.error){console.error("‚ùå WebSocket API error:",t.error),notifyConnectionStatus("error",t.error.message);return}if(t.history)console.log(`üìä Received history for ${currentSymbol}: ${t.history.prices.length} ticks`),tickHistory=t.history.prices.map((e,o)=>({time:t.history.times[o],quote:parseFloat(e)})),detectDecimalPlaces(),updateUI();else if(t.tick){let e=parseFloat(t.tick.quote);tickHistory.push({time:t.tick.epoch,quote:e}),tickHistory.length>tickCount&&tickHistory.shift(),updateUI()}else t.ping&&derivWs.send(JSON.stringify({pong:1}))}catch(e){console.error("Error processing message:",e)}},derivWs.onerror=function(e){console.error("‚ùå WebSocket error:",e),notifyConnectionStatus("error","Connection error"),scheduleReconnect()},derivWs.onclose=function(e){console.log("\uD83D\uDD04 WebSocket connection closed",e.code,e.reason),notifyConnectionStatus("disconnected"),scheduleReconnect()},window.derivWs=derivWs}catch(e){console.error("Failed to create WebSocket:",e),notifyConnectionStatus("error",e.message),scheduleReconnect()}}function scheduleReconnect(){if(++reconnectAttempts>5){console.log(`‚ö†Ô∏è Maximum reconnection attempts (5) reached. Stopping attempts.`),notifyConnectionStatus("error","Maximum reconnection attempts reached");return}let e=Math.min(1e3*Math.pow(1.5,reconnectAttempts-1),3e4);console.log(`üîÑ Scheduling reconnect attempt ${reconnectAttempts} in ${e}ms`),reconnectTimeout=setTimeout(()=>{console.log(`üîÑ Attempting to reconnect (${reconnectAttempts}/5)...`),startWebSocket()},e)}function requestTickHistory(){let e={ticks_history:currentSymbol,count:tickCount,end:"latest",style:"ticks",subscribe:1};if(derivWs&&derivWs.readyState===WebSocket.OPEN){console.log(`üì° Requesting tick history for ${currentSymbol} (${tickCount} ticks)`);try{derivWs.send(JSON.stringify(e))}catch(e){console.error("Error sending tick history request:",e),scheduleReconnect()}}else console.error("‚ùå WebSocket not ready to request history, readyState:",derivWs?derivWs.readyState:"undefined"),scheduleReconnect()}function updateSymbol(e){if(console.log(`üîÑ Updating symbol: ${currentSymbol} -> ${e}`),currentSymbol===e&&derivWs&&derivWs.readyState===WebSocket.OPEN){console.log("Symbol unchanged, skipping reconnection");return}if(currentSymbol=e,tickHistory=[],derivWs&&derivWs.readyState===WebSocket.OPEN)try{console.log("Unsubscribing from current tick before changing symbol..."),derivWs.send(JSON.stringify({forget_all:"ticks"})),setTimeout(()=>requestTickHistory(),300)}catch(e){console.error("Error unsubscribing:",e),startWebSocket()}else startWebSocket()}function updateTickCount(e){if(console.log(`üîÑ Updating tick count: ${tickCount} -> ${e}`),isNaN(e)||e<=0){console.error("Invalid tick count:",e);return}if(tickCount=e,tickHistory=[],derivWs&&derivWs.readyState===WebSocket.OPEN)try{console.log("Unsubscribing before changing tick count..."),derivWs.send(JSON.stringify({forget_all:"ticks"})),setTimeout(()=>requestTickHistory(),300)}catch(e){console.error("Error unsubscribing:",e),startWebSocket()}else startWebSocket()}function updateBarrier(e){console.log(`üîÑ Updating barrier: ${overUnderBarrier} -> ${e}`),overUnderBarrier=e,updateUI()}function detectDecimalPlaces(){if(0!==tickHistory.length)decimalPlaces=Math.max(...tickHistory.map(e=>(e.quote.toString().split(".")[1]||"").length),2)}function getLastDigit(e){let t=e.toString().split(".")[1]||"";for(;t.length<decimalPlaces;)t+="0";return Number(t.slice(-1))}function getStatus(){return{connected:derivWs&&derivWs.readyState===WebSocket.OPEN,symbol:currentSymbol,tickCount:tickCount,dataAvailable:tickHistory.length>0,lastUpdate:Date.now()}}function notifyConnectionStatus(e,t=null){window.postMessage({type:"ANALYZER_CONNECTION_STATUS",status:e,error:t},"*")}function updateUI(){if(0===tickHistory.length){console.warn("‚ö†Ô∏è No tick history available for analysis");return}let e=tickHistory[tickHistory.length-1].quote.toFixed(decimalPlaces);window.postMessage({type:"PRICE_UPDATE",price:e,symbol:currentSymbol},"*"),sendAnalysisData()}function handleMessages(e){if(!e.data||"object"!=typeof e.data)return;let{type:t}=e.data;switch(t){case"UPDATE_SYMBOL":e.data.symbol&&(console.log("Received symbol update request:",e.data.symbol),updateSymbol(e.data.symbol));break;case"UPDATE_TICK_COUNT":let o=e.data.tickCount||e.data.count;o&&!isNaN(o)&&(console.log("Received tick count update request:",o),updateTickCount(parseInt(o,10)));break;case"UPDATE_BARRIER":e.data.barrier&&!isNaN(e.data.barrier)&&updateBarrier(parseInt(e.data.barrier,10));break;case"REQUEST_ANALYSIS":sendAnalysisData(e.data.strategyId);break;case"REQUEST_STATUS":window.postMessage({type:"ANALYZER_STATUS",status:getStatus()},"*")}}function sendAnalysisData(e=null){if(!tickHistory||0===tickHistory.length){console.warn("‚ö†Ô∏è No data available for analysis");return}try{let t=Array(10).fill(0);tickHistory.forEach(e=>{let o=getLastDigit(e.quote);t[o]++});let o=tickHistory.length,r=t.map(e=>(e/o*100).toFixed(2)),i=t.filter((e,t)=>t%2==0).reduce((e,t)=>e+t,0),n=t.filter((e,t)=>t%2!=0).reduce((e,t)=>e+t,0),s=(i/o*100).toFixed(2),a=(n/o*100).toFixed(2),c=0,l=0;for(let e=0;e<10;e++)e>=overUnderBarrier?c+=t[e]:l+=t[e];let d=(c/o*100).toFixed(2),u=(l/o*100).toFixed(2),y=tickHistory.slice(-10).map(e=>getLastDigit(e.quote)),g=y.map(e=>e%2==0?"E":"O"),p=y.map(e=>e>=overUnderBarrier?"O":"U"),b=1,k=y.length>0&&y[y.length-1]%2==0?"even":"odd";for(let e=y.length-2;e>=0;e--){let t=y[e]%2==0,o=y[e+1]%2==0;if(t===o)b++;else break}if(!e||"rise-fall"===e){let e=0,t=0;for(let o=1;o<tickHistory.length;o++)tickHistory[o].quote>tickHistory[o-1].quote?e++:tickHistory[o].quote<tickHistory[o-1].quote&&t++;let r=(e/(o-1)*100).toFixed(2),i=(t/(o-1)*100).toFixed(2);window.postMessage({type:"ANALYSIS_DATA",strategyId:"rise-fall",data:{recommendation:parseFloat(r)>55?"Rise":parseFloat(i)>55?"Fall":null,confidence:Math.max(parseFloat(r),parseFloat(i)).toFixed(2),riseRatio:r,fallRatio:i}},"*"),console.log(`üìä Rise/Fall analysis sent: Rise=${r}%, Fall=${i}%`)}if((!e||"even-odd"===e)&&(window.postMessage({type:"ANALYSIS_DATA",strategyId:"even-odd",data:{recommendation:parseFloat(s)>55?"Even":parseFloat(a)>55?"Odd":null,confidence:Math.max(parseFloat(s),parseFloat(a)).toFixed(2),evenProbability:s,oddProbability:a}},"*"),console.log(`üìä Even/Odd analysis sent: Even=${s}%, Odd=${a}%`)),(!e||"even-odd-2"===e)&&(window.postMessage({type:"ANALYSIS_DATA",strategyId:"even-odd-2",data:{evenProbability:s,oddProbability:a,actualDigits:y,evenOddPattern:g,streak:b,streakType:k}},"*"),console.log(`üìä Even/Odd-2 analysis sent: Pattern=${g.join("")}`)),(!e||"over-under"===e)&&(window.postMessage({type:"ANALYSIS_DATA",strategyId:"over-under",data:{recommendation:d>55?"Over":u>55?"Under":null,confidence:Math.max(d,u).toFixed(2),overProbability:d,underProbability:u,barrier:overUnderBarrier}},"*"),console.log(`üìä Over/Under analysis sent: Over=${d}%, Under=${u}%, Barrier=${overUnderBarrier}`)),(!e||"over-under-2"===e)&&(window.postMessage({type:"ANALYSIS_DATA",strategyId:"over-under-2",data:{overProbability:d,underProbability:u,actualDigits:y,overUnderPattern:p,barrier:overUnderBarrier,digitPercentages:r}},"*"),console.log(`üìä Over/Under-2 analysis sent: Pattern=${p.join("")}`)),!e||"matches-differs"===e){let e=0,r=0;t.forEach((t,o)=>{t>e&&(e=t,r=o)});let i=(e/o*100).toFixed(2),n=t.map((e,t)=>({digit:t,percentage:(e/o*100).toFixed(2),count:e})),s=tickHistory&&tickHistory.length>0?getLastDigit(tickHistory[tickHistory.length-1].quote):void 0;window.postMessage({type:"ANALYSIS_DATA",strategyId:"matches-differs",data:{recommendation:parseFloat(i)>15?"Matches":"Differs",confidence:(parseFloat(i)>15?parseFloat(i):100-parseFloat(i)).toFixed(2),target:r,mostFrequentProbability:i,digitFrequencies:n,currentLastDigit:s,totalTicks:o}},"*"),console.log(`üìä Matches/Differs analysis sent: Target=${r}, Current=${s}, Probability=${i}%`)}}catch(e){console.error("‚ùå Error in sendAnalysisData:",e)}}window.initVolatilityAnalyzer=function(){!isInitialized&&(isInitialized=!0,console.log("\uD83D\uDE80 Initializing volatility analyzer"),startWebSocket(),window.addEventListener("message",handleMessages),window.volatilityAnalyzer={updateSymbol:updateSymbol,updateTickCount:updateTickCount,updateBarrier:updateBarrier,getStatus:getStatus,reconnect:startWebSocket},window.derivWs=derivWs,window.tickHistory=tickHistory,window.getLastDigit=getLastDigit,window.updateUI=updateUI,window.updateSymbol=updateSymbol,window.updateTickCount=updateTickCount,window.decimalPlaces=decimalPlaces,window.currentSymbol=currentSymbol)},window.initVolatilityAnalyzer();