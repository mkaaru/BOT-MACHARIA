// deriv_trade_bot.js
const WebSocket = require('ws');
const express = require('express');
const app = express();
const port = 3000;

const API_TOKEN = 'YOUR_API_TOKEN'; // Replace with your Deriv API token
const DERIV_APP_ID = 1089; // Use your registered app_id for production
let ws;

let currentSymbol = 'R_100';
let currentContract = 'DIGITEVEN';
let isRunning = false;

// Optional strategy condition: wait for tick ending in 2, 4, 6, 8, 0
function isGoodCondition(lastDigit, contractType) {
  if (contractType === 'DIGITEVEN') return [0, 2, 4, 6, 8].includes(lastDigit);
  if (contractType === 'DIGITODD') return [1, 3, 5, 7, 9].includes(lastDigit);
  return true; // for other types like RISE/FALL
}

function connectWebSocket() {
  ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${DERIV_APP_ID}`);

  ws.on('open', () => {
    console.log('🔌 Connected to Deriv API');
    ws.send(JSON.stringify({ authorize: API_TOKEN }));
  });

  ws.on('message', async (data) => {
    const response = JSON.parse(data);

    if (response.msg_type === 'authorize') {
      console.log('✅ Authorized');
      subscribeTicks();
    }

    if (response.msg_type === 'tick') {
      const lastDigit = Number(response.tick.quote.toString().slice(-1));
      console.log(`📉 Tick: ${response.tick.quote} (Last Digit: ${lastDigit})`);

      if (isRunning && isGoodCondition(lastDigit, currentContract)) {
        requestProposal();
      }
    }

    if (response.msg_type === 'proposal') {
      const proposalId = response.proposal.id;
      const price = response.proposal.display_value;

      console.log(`💰 Proposal ${currentContract} @ $${price}`);

      ws.send(JSON.stringify({
        buy: proposalId,
        price: price
      }));
    }

    if (response.msg_type === 'buy') {
      console.log('🎉 Bought Contract ID:', response.buy.contract_id);
    }

    if (response.msg_type === 'error') {
      console.error('❌ Error:', response.error.message);
    }
  });
}

function subscribeTicks() {
  ws.send(JSON.stringify({ ticks: currentSymbol }));
}

function requestProposal() {
  ws.send(JSON.stringify({
    proposal: 1,
    amount: 1,
    basis: 'stake',
    contract_type: currentContract,
    currency: 'USD',
    symbol: currentSymbol,
    duration: 1,
    duration_unit: 't'
  }));
}

// 🔌 Web API endpoints
app.use(express.json());

app.post('/start', (req, res) => {
  const { symbol, contract_type } = req.body;
  currentSymbol = symbol || currentSymbol;
  currentContract = contract_type || currentContract;
  isRunning = true;
  connectWebSocket();
  res.send(`🚀 Started trading ${currentContract} on ${currentSymbol}`);
});

app.post('/stop', (req, res) => {
  isRunning = false;
  if (ws) ws.close();
  res.send('🛑 Trading stopped');
});

app.listen(port, () => {
  console.log(`🧠 Deriv bot listening at http://localhost:${port}`);
});
