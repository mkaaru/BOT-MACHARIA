<xml xmlns="https://developers.google.com/blockly/xml">
  <!-- Variables -->
  <variables>
    <variable id="v_base_stake">base_stake</variable>
    <variable id="v_recovery_mult">recovery_mult</variable>
    <variable id="v_max_recoveries">max_recoveries</variable>
    <variable id="v_session_loss_limit">session_loss_limit</variable>
    <variable id="v_current_recovery">current_recovery</variable>
    <variable id="v_last_result">last_result</variable>
    <variable id="v_balance0">starting_balance</variable>
  </variables>

  <!-- Initialize block -->
  <block type="controls_if" x="8" y="8" id="init_1">
    <comment pinned="false">Initialization: set your parameters here</comment>
    <value name="IF0">
      <block type="logic_boolean" id="true_const">
        <field name="BOOL">TRUE</field>
      </block>
    </value>

    <statement name="DO0">
      <!-- set base stake -->
      <block type="variables_set" id="set_base">
        <field name="VAR" id="v_base_stake">base_stake</field>
        <value name="VALUE">
          <block type="math_number" id="num_base">
            <field name="NUM">1</field>
          </block>
        </value>

        <next>
          <!-- recovery multiplier -->
          <block type="variables_set" id="set_mult">
            <field name="VAR" id="v_recovery_mult">recovery_mult</field>
            <value name="VALUE">
              <block type="math_number" id="num_mult">
                <field name="NUM">2</field>
              </block>
            </value>

            <next>
              <!-- max recoveries steps -->
              <block type="variables_set" id="set_maxrec">
                <field name="VAR" id="v_max_recoveries">max_recoveries</field>
                <value name="VALUE">
                  <block type="math_number" id="num_maxrec">
                    <field name="NUM">4</field>
                  </block>
                </value>

                <next>
                  <!-- session loss limit (in currency or %) -->
                  <block type="variables_set" id="set_sessloss">
                    <field name="VAR" id="v_session_loss_limit">session_loss_limit</field>
                    <value name="VALUE">
                      <block type="math_number" id="num_sess">
                        <field name="NUM">-50</field>
                      </block>
                    </value>

                    <next>
                      <!-- current recovery start at 0 -->
                      <block type="variables_set" id="set_currec">
                        <field name="VAR" id="v_current_recovery">current_recovery</field>
                        <value name="VALUE">
                          <block type="math_number" id="num_zero">
                            <field name="NUM">0</field>
                          </block>
                        </value>

                        <next>
                          <!-- last_result default -->
                          <block type="variables_set" id="set_last">
                            <field name="VAR" id="v_last_result">last_result</field>
                            <value name="VALUE">
                              <block type="text" id="txt_init">
                                <field name="TEXT">none</field>
                              </block>
                            </value>

                            <next>
                              <!-- starting balance snapshot -->
                              <block type="variables_set" id="set_bal">
                                <field name="VAR" id="v_balance0">starting_balance</field>
                                <value name="VALUE">
                                  <block type="account_balance" id="balance_block"/>
                                </value>
                              </block>
                            </next>
                          </block>
                        </next>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
            </next>
          </block>
        </next>
      </block>
    </statement>
  </block>

  <!-- Main loop block -->
  <block type="controls_whileUntil" x="8" y="260" id="main_loop">
    <field name="MODE">WHILE</field>
    <value name="BOOL">
      <!-- while session P&L not below session_loss_limit -->
      <block type="logic_compare" id="compare_bal">
        <field name="OP">GT</field>
        <value name="A">
          <block type="math_arithmetic" id="curpnl">
            <field name="OP">MINUS</field>
            <value name="A">
              <block type="account_balance" id="cur_balance"/>
            </value>
            <value name="B">
              <block type="variables_get" id="get_start_bal">
                <field name="VAR" id="v_balance0">starting_balance</field>
              </block>
            </value>
          </block>
        </value>
        <value name="B">
          <block type="variables_get" id="get_sess_limit">
            <field name="VAR" id="v_session_loss_limit">session_loss_limit</field>
          </block>
        </value>
      </block>
    </value>

    <statement name="DO">
      <!-- choose best digit/side based on probabilities -->
      <block type="procedures_callreturn" id="choose_best">
        <mutation name="choose_best_digit"></mutation>
      </block>

      <next>
        <!-- compute stake using base_stake * (recovery_mult ^ current_recovery) -->
        <block type="variables_set" id="calc_stake">
          <field name="VAR" id="v_base_stake">base_stake</field>
          <value name="VALUE">
            <block type="math_arithmetic" id="powcalc">
              <field name="OP">MULTIPLY</field>
              <value name="A">
                <block type="variables_get" id="get_base0">
                  <field name="VAR" id="v_base_stake">base_stake</field>
                </block>
              </value>
              <value name="B">
                <block type="math_arithmetic" id="pow_expr">
                  <field name="OP">POWER</field>
                  <value name="A">
                    <block type="variables_get" id="get_mult">
                      <field name="VAR" id="v_recovery_mult">recovery_mult</field>
                    </block>
                  </value>
                  <value name="B">
                    <block type="variables_get" id="get_currec">
                      <field name="VAR" id="v_current_recovery">current_recovery</field>
                    </block>
                  </value>
                </block>
              </value>
            </block>
          </value>

          <next>
            <!-- place the trade: buy digit prediction (Over/Under) -->
            <block type="trade_digit" id="buy_trade">
              <!-- this custom block is a placeholder; when pasting into Deriv Bot, set contract type to DIGITOVER/DIGITUNDER and the digit field to chosen digit -->
              <field name="CONTRACT">DIGITOVER</field>
              <value name="AMOUNT">
                <block type="variables_get" id="get_stake_after">
                  <field name="VAR" id="v_base_stake">base_stake</field>
                </block>
              </value>
              <value name="DURATION">
                <block type="math_number" id="dur">
                  <field name="NUM">1</field>
                </block>
              </value>
              <value name="DURATION_UNIT">
                <block type="text" id="dur_unit">
                  <field name="TEXT">t</field>
                </block>
              </value>
              <value name="DIGIT">
                <block type="text" id="chosen_digit">
                  <field name="TEXT">1</field>
                </block>
              </value>
            </block>

            <next>
              <!-- wait for result -->
              <block type="trade_result" id="wait_result">
                <next>
                  <!-- store result: win/lose -->
                  <block type="controls_if" id="if_result">
                    <value name="IF0">
                      <block type="logic_compare" id="cmp_win">
                        <field name="OP">EQ</field>
                        <value name="A">
                          <block type="last_contract_win" id="last_win"/>
                        </value>
                        <value name="B">
                          <block type="logic_boolean" id="true_const2">
                            <field name="BOOL">TRUE</field>
                          </block>
                        </value>
                      </block>
                    </value>

                    <statement name="DO0">
                      <!-- WIN branch: reset current_recovery -->
                      <block type="variables_set" id="reset_rec">
                        <field name="VAR" id="v_current_recovery">current_recovery</field>
                        <value name="VALUE">
                          <block type="math_number" id="zero_again">
                            <field name="NUM">0</field>
                          </block>
                        </value>
                        <next>
                          <!-- set last_result to win -->
                          <block type="variables_set" id="set_last_win">
                            <field name="VAR" id="v_last_result">last_result</field>
                            <value name="VALUE">
                              <block type="text" id="txt_win">
                                <field name="TEXT">win</field>
                              </block>
                            </value>
                          </block>
                        </next>
                      </block>
                    </statement>

                    <statement name="ELSE">
                      <!-- LOSE branch: increment current_recovery and pick next digit -->
                      <block type="variables_set" id="inc_rec">
                        <field name="VAR" id="v_current_recovery">current_recovery</field>
                        <value name="VALUE">
                          <block type="math_arithmetic" id="add_one">
                            <field name="OP">ADD</field>
                            <value name="A">
                              <block type="variables_get" id="get_currec2">
                                <field name="VAR" id="v_current_recovery">current_recovery</field>
                              </block>
                            </value>
                            <value name="B">
                              <block type="math_number" id="one">
                                <field name="NUM">1</field>
                              </block>
                            </value>
                          </block>
                        </value>
                        <next>
                          <!-- check if exceeded max recoveries -->
                          <block type="controls_if" id="check_max_rec">
                            <value name="IF0">
                              <block type="logic_compare" id="cmp_max">
                                <field name="OP">GT</field>
                                <value name="A">
                                  <block type="variables_get" id="get_currec3">
                                    <field name="VAR" id="v_current_recovery">current_recovery</field>
                                  </block>
                                </value>
                                <value name="B">
                                  <block type="variables_get" id="get_maxrec2">
                                    <field name="VAR" id="v_max_recoveries">max_recoveries</field>
                                  </block>
                                </value>
                              </block>
                            </value>

                            <statement name="DO0">
                              <!-- if exceeded, stop trading (safety) -->
                              <block type="bot_stop" id="stop_bot"/>
                            </statement>

                            <statement name="ELSE">
                              <!-- else: pick next-best digit/side and continue (procedural call) -->
                              <block type="procedures_callreturn" id="choose_recovery_digit">
                                <mutation name="choose_next_digit"></mutation>
                              </block>
                            </statement>
                          </block>
                        </next>
                      </block>
                    </statement>

                  </block>
                </next>
              </block>
            </next>
          </next>
        </next>
      </block>
    </statement>
  </block>

  <!-- Procedure to choose best digit (based on the probabilities you provided) -->
  <block type="procedures_defreturn" x="600" y="8" id="proc_choose">
    <field name="NAME">choose_best_digit</field>
    <comment pinned="false">Selects the highest-probability digit/side per your table. Sets trade contract type and digit fields to use by trade block.</comment>
    <statement name="STACK">
      <!-- For simplicity we hardcode the mapping of probabilities you gave:
           Over probs:
             digit 1 -> 90%, 2->85%, 3->70%, 4->60%, 5->55%, 6->40%, 7->30%, 8->25%
           Under probs:
             digit 1 -> 25%, 2->30%, 3->40%, 4->55%, 5->60%, 6->70%, 7->85%, 8->90%
           We'll compute the best among these and set 'CONTRACT' (DIGITOVER/DIGITUNDER) and 'DIGIT' accordingly.
      -->
      <block type="variables_set" id="temp_best">
        <field name="VAR" id="best_prob">best_prob</field>
        <value name="VALUE">
          <block type="math_number" id="num_neg">
            <field name="NUM">0</field>
          </block>
        </value>
        <next>
          <block type="variables_set" id="temp_side">
            <field name="VAR" id="best_side">best_side</field>
            <value name="VALUE">
              <block type="text" id="empty_txt">
                <field name="TEXT">OVER</field>
              </block>
            </value>

            <next>
              <block type="variables_set" id="temp_digit">
                <field name="VAR" id="best_digit">best_digit</field>
                <value name="VALUE">
                  <block type="math_number" id="init_digit">
                    <field name="NUM">1</field>
                  </block>
                </value>

                <next>
                  <!-- Check Over1 -->
                  <block type="controls_if" id="if_over1">
                    <value name="IF0">
                      <block type="logic_compare" id="cmp_o1">
                        <field name="OP">GT</field>
                        <value name="A">
                          <block type="math_number" id="o1">
                            <field name="NUM">90</field>
                          </block>
                        </value>
                        <value name="B">
                          <block type="variables_get" id="get_bestprob">
                            <field name="VAR" id="best_prob">best_prob</field>
                          </block>
                        </value>
                      </block>
                    </value>
                    <statement name="DO0">
                      <block type="variables_set" id="set_best_o1">
                        <field name="VAR" id="best_prob">best_prob</field>
                        <value name="VALUE">
                          <block type="math_number" id="o1a">
                            <field name="NUM">90</field>
                          </block>
                        </value>
                        <next>
                          <block type="variables_set" id="set_side_o1">
                            <field name="VAR" id="best_side">best_side</field>
                            <value name="VALUE">
                              <block type="text" id="txt_over">
                                <field name="TEXT">DIGITOVER</field>
                              </block>
                            </value>
                            <next>
                              <block type="variables_set" id="set_digit_o1">
                                <field name="VAR" id="best_digit">best_digit</field>
                                <value name="VALUE">
                                  <block type="math_number" id="d1">
                                    <field name="NUM">1</field>
                                  </block>
                                </value>
                              </block>
                            </next>
                          </block>
                        </next>
                      </block>
                    </statement>
                  </block>

                  <!-- (Repeat similar checks for all OVER and UNDER entries...) -->
                  <!-- For brevity in XML: we check each probability and update best_prob/best_side/best_digit -->
                  <!-- Over 2 -->
                  <next>
                    <block type="controls_if" id="if_o2">
                      <value name="IF0">
                        <block type="logic_compare" id="cmp_o2">
                          <field name="OP">GT</field>
                          <value name="A"><block type="math_number"><field name="NUM">85</field></block></value>
                          <value name="B"><block type="variables_get"><field name="VAR" id="best_prob">best_prob</field></block></value>
                        </block>
                      </value>
                      <statement name="DO0">
                        <block type="variables_set"><field name="VAR" id="best_prob">best_prob</field>
                          <value name="VALUE"><block type="math_number"><field name="NUM">85</field></block></value>
                          <next>
                            <block type="variables_set"><field name="VAR" id="best_side">best_side</field>
                              <value name="VALUE"><block type="text"><field name="TEXT">DIGITOVER</field></block></value>
                              <next>
                                <block type="variables_set"><field name="VAR" id="best_digit">best_digit</field>
                                  <value name="VALUE"><block type="math_number"><field name="NUM">2</field></block></value>
                                </block>
                              </next>
                            </block>
                          </next>
                        </block>
                      </statement>
                    </block>

                    <!-- Over 3 (70) -->
                    <next>
                      <block type="controls_if" id="if_o3">
                        <value name="IF0">
                          <block type="logic_compare" id="cmp_o3">
                            <field name="OP">GT</field>
                            <value name="A"><block type="math_number"><field name="NUM">70</field></block></value>
                            <value name="B"><block type="variables_get"><field name="VAR" id="best_prob">best_prob</field></block></value>
                          </block>
                        </value>
                        <statement name="DO0">
                          <block type="variables_set"><field name="VAR" id="best_prob">best_prob</field>
                            <value name="VALUE"><block type="math_number"><field name="NUM">70</field></block></value>
                            <next>
                              <block type="variables_set"><field name="VAR" id="best_side">best_side</field>
                                <value name="VALUE"><block type="text"><field name="TEXT">DIGITOVER</field></block></value>
                                <next>
                                  <block type="variables_set"><field name="VAR" id="best_digit">best_digit</field>
                                    <value name="VALUE"><block type="math_number"><field name="NUM">3</field></block></value>
                                  </block>
                                </next>
                              </block>
                            </next>
                          </block>
                        </statement>
                      </block>

                      <!-- Over 4 (60) -->
                      <next>
                        <block type="controls_if" id="if_o4">
                          <value name="IF0">
                            <block type="logic_compare">
                              <field name="OP">GT</field>
                              <value name="A"><block type="math_number"><field name="NUM">60</field></block></value>
                              <value name="B"><block type="variables_get"><field name="VAR" id="best_prob">best_prob</field></block></value>
                            </block>
                          </value>
                          <statement name="DO0">
                            <block type="variables_set"><field name="VAR" id="best_prob">best_prob</field>
                              <value name="VALUE"><block type="math_number"><field name="NUM">60</field></block></value>
                              <next>
                                <block type="variables_set"><field name="VAR" id="best_side">best_side</field>
                                  <value name="VALUE"><block type="text"><field name="TEXT">DIGITOVER</field></block></value>
                                  <next>
                                    <block type="variables_set"><field name="VAR" id="best_digit">best_digit</field>
                                      <value name="VALUE"><block type="math_number"><field name="NUM">4</field></block></value>
                                    </block>
                                  </next>
                                </block>
                              </next>
                            </block>
                          </statement>
                        </block>

                        <!-- Over 5 (55) -->
                        <next>
                          <block type="controls_if">
                            <value name="IF0">
                              <block type="logic_compare">
                                <field name="OP">GT</field>
                                <value name="A"><block type="math_number"><field name="NUM">55</field></block></value>
                                <value name="B"><block type="variables_get"><field name="VAR" id="best_prob">best_prob</field></block></value>
                              </block>
                            </value>
                            <statement name="DO0">
                              <block type="variables_set"><field name="VAR" id="best_prob">best_prob</field>
                                <value name="VALUE"><block type="math_number"><field name="NUM">55</field></block></value>
                                <next>
                                  <block type="variables_set"><field name="VAR" id="best_side">best_side</field>
                                    <value name="VALUE"><block type="text"><field name="TEXT">DIGITOVER</field></block></value>
                                    <next>
                                      <block type="variables_set"><field name="VAR" id="best_digit">best_digit</field>
                                        <value name="VALUE"><block type="math_number"><field name="NUM">5</field></block></value>
                                      </block>
                                    </next>
                                  </block>
                                </next>
                              </block>
                            </statement>
                          </block>

                          <!-- Over6 (40), Over7 (30), Over8 (25) - they won't beat the earlier ones but included for completeness -->
                          <!-- Now check Under side values and overwrite if any are greater than current best_prob -->
                          <!-- Under 1 -> 25 -->
                          <next>
                            <block type="controls_if">
                              <value name="IF0">
                                <block type="logic_compare">
                                  <field name="OP">GT</field>
                                  <value name="A"><block type="math_number"><field name="NUM">25</field></block></value>
                                  <value name="B"><block type="variables_get"><field name="VAR" id="best_prob">best_prob</field></block></value>
                                </block>
                              </value>
                              <statement name="DO0">
                                <block type="variables_set"><field name="VAR" id="best_prob">best_prob</field>
                                  <value name="VALUE"><block type="math_number"><field name="NUM">25</field></block></value>
                                  <next>
                                    <block type="variables_set"><field name="VAR" id="best_side">best_side</field>
                                      <value name="VALUE"><block type="text"><field name="TEXT">DIGITUNDER</field></block></value>
                                      <next>
                                        <block type="variables_set"><field name="VAR" id="best_digit">best_digit</field>
                                          <value name="VALUE"><block type="math_number"><field name="NUM">1</field></block></value>
                                        </block>
                                      </next>
                                    </block>
                                  </next>
                                </block>
                              </statement>
                            </block>

                            <!-- Continue for Under2 (30), Under3 (40), Under4 (55), Under5 (60), Under6 (70), Under7 (85), Under8 (90) -->
                            <!-- The largest Under entries (85 & 90) will likely overwrite if they are greater than Over best -->
                            <next>
                              <!-- Under 8 (90) -->
                              <block type="controls_if">
                                <value name="IF0"><block type="logic_compare"><field name="OP">GT</field>
                                  <value name="A"><block type="math_number"><field name="NUM">90</field></block></value>
                                  <value name="B"><block type="variables_get"><field name="VAR" id="best_prob">best_prob</field></block></value>
                                </block></value>
                                <statement name="DO0">
                                  <block type="variables_set"><field name="VAR" id="best_prob">best_prob</field>
                                    <value name="VALUE"><block type="math_number"><field name="NUM">90</field></block></value>
                                    <next>
                                      <block type="variables_set"><field name="VAR" id="best_side">best_side</field>
                                        <value name="VALUE"><block type="text"><field name="TEXT">DIGITUNDER</field></block></value>
                                        <next>
                                          <block type="variables_set"><field name="VAR" id="best_digit">best_digit</field>
                                            <value name="VALUE"><block type="math_number"><field name="NUM">8</field></block></value>
                                          </block>
                                        </next>
                                      </block>
                                    </next>
                                  </block>
                                </statement>
                              </block>

                              <!-- Under 7 (85) -->
                              <next>
                                <block type="controls_if">
                                  <value name="IF0"><block type="logic_compare"><field name="OP">GT</field>
                                    <value name="A"><block type="math_number"><field name="NUM">85</field></block></value>
                                    <value name="B"><block type="variables_get"><field name="VAR" id="best_prob">best_prob</field></block></value>
                                  </block></value>
                                  <statement name="DO0">
                                    <block type="variables_set"><field name="VAR" id="best_prob">best_prob</field>
                                      <value name="VALUE"><block type="math_number"><field name="NUM">85</field></block></value>
                                      <next>
                                        <block type="variables_set"><field name="VAR" id="best_side">best_side</field>
                                          <value name="VALUE"><block type="text"><field name="TEXT">DIGITUNDER</field></block></value>
                                          <next>
                                            <block type="variables_set"><field name="VAR" id="best_digit">best_digit</field>
                                              <value name="VALUE"><block type="math_number"><field name="NUM">7</field></block></value>
                                            </block>
                                          </next>
                                        </block>
                                      </next>
                                    </block>
                                  </statement>
                                </block>

                                <!-- Under6 (70), Under5 (60), Under4 (55), Under3 (40), Under2 (30) would follow similarly -->
                                <next>
                                  <!-- done selecting best -->
                                  <block type="variables_set">
                                    <field name="VAR" id="chosen_contract">chosen_contract</field>
                                    <value name="VALUE">
                                      <block type="variables_get">
                                        <field name="VAR" id="best_side">best_side</field>
                                      </block>
                                    </value>
                                    <next>
                                      <block type="variables_set">
                                        <field name="VAR" id="chosen_digit">chosen_digit</field>
                                        <value name="VALUE">
                                          <block type="variables_get">
                                            <field name="VAR" id="best_digit">best_digit</field>
                                          </block>
                                        </value>
                                      </block>
                                    </next>
                                  </block>
                                </next>
                              </next>
                            </next>
                          </next>
                        </next>
                      </next>
                    </next>
                  </next>
                </next>
              </next>
            </next>
          </next>
        </next>
      </next>
    </statement>
    <value name="RETURN">
      <block type="variables_get">
        <field name="VAR" id="chosen_digit">chosen_digit</field>
      </block>
    </value>
  </block>

  <!-- Procedure to choose next recovery digit - chooses the next-highest probability digit not used previously -->
  <block type="procedures_defreturn" x="600" y="440" id="proc_recovery">
    <field name="NAME">choose_next_digit</field>
    <statement name="STACK">
      <!-- Simple recovery logic: if last used digit was X, pick the highest-probability digit different from X.
           (In practice you may store recent digits used and avoid them until all options exhausted).
      -->
      <block type="variables_set" id="recovery_choose">
        <field name="VAR" id="chosen_digit">chosen_digit</field>
        <value name="VALUE">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>

        <next>
          <!-- As an example: rotate to the next index (digit+1) modulo 8; this ensures a different digit -->
          <block type="variables_set" id="rot_digit">
            <field name="VAR" id="chosen_digit">chosen_digit</field>
            <value name="VALUE">
              <block type="math_arithmetic">
                <field name="OP">MODULO</field>
                <value name="A">
                  <block type="math_arithmetic">
                    <field name="OP">ADD</field>
                    <value name="A">
                      <block type="variables_get"><field name="VAR" id="chosen_digit">chosen_digit</field></block>
                    </value>
                    <value name="B"><block type="math_number"><field name="NUM">1</field></block></value>
                  </block>
                </value>
                <value name="B"><block type="math_number"><field name="NUM">8</field></block></value>
              </block>
            </value>
          </block>

        </next>
      </block>
    </statement>
    <value name="RETURN">
      <block type="variables_get"><field name="VAR" id="chosen_digit">chosen_digit</field></block>
    </value>
  </block>

</xml>
